{% extends "base.html" %}

{% block title %}Settings - Shree Balaji Centring Works{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="page-title">Settings</h1>
                <p class="page-subtitle">Manage holidays and application settings</p>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="showAddHolidayModal()">
                    <i class="icon">üéâ</i>
                    Add Holiday
                </button>
                <button class="btn btn-secondary" onclick="loadSuggestedHolidays()">
                    <i class="icon">‚ú®</i>
                    Suggested Holidays
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Tabs -->
    <div class="settings-tabs">
        <button class="tab-btn active" onclick="showTab('holidays')">
            <i class="icon">üìÖ</i>
            Holiday Management
        </button>
        <button class="tab-btn" onclick="showTab('general')">
            <i class="icon">‚öôÔ∏è</i>
            General Settings
        </button>
        <button class="tab-btn" onclick="showTab('backup')">
            <i class="icon">üíæ</i>
            Backup & Data
        </button>
    </div>

    <!-- Holiday Management Tab -->
    <div class="tab-content active" id="holidaysTab">
        <div class="holiday-section">
            <div class="section-header">
                <h3>Holiday Calendar</h3>
                <div class="holiday-controls">
                    <select id="holidayYear" class="form-select" onchange="loadHolidays()">
                        <!-- Years will be populated by JavaScript -->
                    </select>
                    <select id="holidayMonth" class="form-select" onchange="loadHolidays()">
                        <option value="">All Months</option>
                        <!-- Months will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            
            <div class="holidays-grid" id="holidaysGrid">
                <!-- Holidays will be loaded here -->
            </div>
        </div>
    </div>

    <!-- General Settings Tab -->
    <div class="tab-content" id="generalTab">
        <div class="settings-section">
            <h3>Application Settings</h3>
            <div class="settings-form">
                <div class="form-group">
                    <label for="companyName">Company Name</label>
                    <input type="text" id="companyName" class="form-input" value="BlazeCore" placeholder="Enter company name">
                </div>
                
                <div class="form-group">
                    <label for="currency">Currency</label>
                    <select id="currency" class="form-select">
                        <option value="INR" selected>Indian Rupee (‚Çπ)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (‚Ç¨)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Working Days</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Monday
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Tuesday
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Wednesday
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Thursday
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Friday
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Saturday
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox"> Sunday
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" checked> Auto-mark Sundays as holidays
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" checked> Show Hindu calendar information
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="saveGeneralSettings()">
                    <i class="icon">üíæ</i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Backup & Data Tab -->
    <div class="tab-content" id="backupTab">
        <div class="settings-section">
            <h3>Backup & Data Management</h3>
            <div class="backup-options">
                <div class="backup-card">
                    <div class="backup-icon">üì§</div>
                    <div class="backup-content">
                        <h4>Export Data</h4>
                        <p>Export all worker data, attendance, and payroll records</p>
                        <button class="btn btn-primary" onclick="exportData()">Export Database</button>
                    </div>
                </div>
                
                <div class="backup-card">
                    <div class="backup-icon">üì•</div>
                    <div class="backup-content">
                        <h4>Import Data</h4>
                        <p>Import data from a backup file</p>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData()">
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                            Choose File
                        </button>
                    </div>
                </div>
                
                <div class="backup-card danger">
                    <div class="backup-icon">üóëÔ∏è</div>
                    <div class="backup-content">
                        <h4>Clear All Data</h4>
                        <p>Permanently delete all data (cannot be undone)</p>
                        <button class="btn btn-danger" onclick="confirmClearData()">Clear Database</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Holiday Modal -->
<div class="modal" id="addHolidayModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Holiday</h3>
            <button class="modal-close" onclick="closeModal('addHolidayModal')">&times;</button>
        </div>
        <form id="addHolidayForm">
            <div class="form-group">
                <label for="holidayDate">Date</label>
                <input type="date" id="holidayDate" name="date" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="holidayName">Holiday Name</label>
                <input type="text" id="holidayName" name="name" class="form-input" placeholder="e.g., Diwali, Independence Day" required>
            </div>
            <div class="form-group">
                <label for="holidayType">Type</label>
                <select id="holidayType" name="type" class="form-select">
                    <option value="festival">Festival</option>
                    <option value="national">National Holiday</option>
                    <option value="lunar">Lunar Day (Amavasya/Purnima)</option>
                    <option value="manual">Manual/Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label for="holidayDescription">Description (Optional)</label>
                <input type="text" id="holidayDescription" name="description" class="form-input" placeholder="Brief description or significance">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addHolidayModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Holiday</button>
            </div>
        </form>
    </div>
</div>

<!-- Suggested Holidays Modal -->
<div class="modal" id="suggestedHolidaysModal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3>Suggested Holidays</h3>
            <button class="modal-close" onclick="closeModal('suggestedHolidaysModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="suggested-controls">
                <select id="suggestedYear" class="form-select" onchange="loadSuggestedHolidays()">
                    <!-- Years will be populated -->
                </select>
                <select id="suggestedMonth" class="form-select" onchange="loadSuggestedHolidays()">
                    <option value="">All Months</option>
                    <!-- Months will be populated -->
                </select>
            </div>
            <div class="suggested-holidays" id="suggestedHolidaysList">
                <!-- Suggested holidays will be loaded here -->
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal('suggestedHolidaysModal')">Close</button>
            <button type="button" class="btn btn-primary" onclick="addSelectedHolidays()">Add Selected</button>
        </div>
    </div>
</div>

<style>
.settings-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.settings-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 30px;
    border-bottom: 2px solid var(--border-color);
}

.tab-btn {
    padding: 12px 20px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
}

.tab-btn.active {
    background: var(--primary-color);
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.holiday-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.holiday-controls {
    display: flex;
    gap: 10px;
}

.holidays-grid {
    display: grid;
    gap: 15px;
}

.holiday-card {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 4px solid var(--primary-color);
}

.holiday-card.festival {
    border-left-color: var(--warning-color);
}

.holiday-card.national {
    border-left-color: var(--success-color);
}

.holiday-card.lunar {
    border-left-color: var(--info-color);
}

.holiday-info h4 {
    margin: 0 0 5px 0;
    color: var(--text-primary);
}

.holiday-info p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 14px;
}

.holiday-date {
    font-weight: 600;
    color: var(--primary-color);
}

.settings-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
}

.settings-form {
    max-width: 500px;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.backup-options {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

.backup-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.backup-card:hover {
    border-color: var(--primary-color);
}

.backup-card.danger {
    border-color: var(--danger-color);
}

.backup-card.danger:hover {
    background: rgba(239, 68, 68, 0.1);
}

.backup-icon {
    font-size: 32px;
}

.backup-content h4 {
    margin: 0 0 5px 0;
    color: var(--text-primary);
}

.backup-content p {
    margin: 0 0 15px 0;
    color: var(--text-secondary);
    font-size: 14px;
}

.suggested-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.suggested-holidays {
    max-height: 400px;
    overflow-y: auto;
}

.suggested-holiday {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
}

.suggested-holiday:last-child {
    border-bottom: none;
}

.suggested-holiday input[type="checkbox"] {
    margin: 0;
}

.modal-content.large {
    max-width: 600px;
}

@media (max-width: 768px) {
    .settings-tabs {
        flex-direction: column;
    }
    
    .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .holiday-controls {
        justify-content: stretch;
    }
    
    .holiday-card {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        gap: 10px;
    }
    
    .backup-options {
        grid-template-columns: 1fr;
    }
    
    .backup-card {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeSettings();
});

function initializeSettings() {
    populateYearSelectors();
    populateMonthSelectors();
    loadHolidays();
    
    // Set current date as default for add holiday
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('holidayDate').value = today;
}

function populateYearSelectors() {
    const currentYear = new Date().getFullYear();
    const yearSelectors = ['holidayYear', 'suggestedYear'];
    
    yearSelectors.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        select.innerHTML = '';
        
        for (let year = currentYear + 1; year >= currentYear - 2; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) option.selected = true;
            select.appendChild(option);
        }
    });
}

function populateMonthSelectors() {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    const monthSelectors = ['holidayMonth', 'suggestedMonth'];
    
    monthSelectors.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (selectorId !== 'suggestedMonth') {
            select.innerHTML = '<option value="">All Months</option>';
        }
        
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index + 1;
            option.textContent = month;
            select.appendChild(option);
        });
    });
}

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    // Fix: Get the clicked button from the onclick event
    const clickedBtn = event.target;
    clickedBtn.classList.add('active');
}

async function loadHolidays() {
    const year = document.getElementById('holidayYear').value;
    const month = document.getElementById('holidayMonth').value;
    const holidaysGrid = document.getElementById('holidaysGrid');
    
    try {
        let url = `/api/holidays?year=${year}`;
        if (month) url += `&month=${month}`;
        
        const response = await fetch(url);
        const holidays = await response.json();
        
        if (holidays.length === 0) {
            holidaysGrid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <h3>No Holidays Found</h3>
                    <p>No holidays are currently configured for this period.</p>
                    <button class="btn btn-primary" onclick="showAddHolidayModal()">Add Holiday</button>
                </div>
            `;
            return;
        }
        
        holidaysGrid.innerHTML = holidays.map(holiday => `
            <div class="holiday-card ${holiday.type}">
                <div class="holiday-info">
                    <h4>${holiday.name}</h4>
                    <p>${holiday.description || holiday.type}</p>
                </div>
                <div class="holiday-actions">
                    <div class="holiday-date">${new Date(holiday.date).toLocaleDateString()}</div>
                    <button class="btn btn-danger btn-sm" onclick="deleteHoliday(${holiday.id})">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        holidaysGrid.innerHTML = `
            <div class="error-state">
                <p>Failed to load holidays: ${error.message}</p>
            </div>
        `;
    }
}

async function deleteHoliday(holidayId) {
    if (!confirm('Are you sure you want to delete this holiday?')) return;
    
    try {
        const response = await fetch(`/api/holidays/${holidayId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Holiday deleted successfully!');
            loadHolidays();
        } else {
            showToast('Failed to delete holiday: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Failed to delete holiday: ' + error.message, 'error');
    }
}

function showAddHolidayModal() {
    showModal('addHolidayModal');
}

document.getElementById('addHolidayForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const holidayData = {
        date: formData.get('date'),
        name: formData.get('name'),
        type: formData.get('type'),
        description: formData.get('description')
    };
    
    try {
        const response = await fetch('/api/holidays', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(holidayData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message);
            closeModal('addHolidayModal');
            e.target.reset();
            loadHolidays();
        } else {
            showToast('Failed to add holiday: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Failed to add holiday: ' + error.message, 'error');
    }
});

async function loadSuggestedHolidays() {
    const year = document.getElementById('suggestedYear')?.value || new Date().getFullYear();
    const month = document.getElementById('suggestedMonth')?.value || '';
    
    // Populate selectors if not already done
    if (!document.getElementById('suggestedYear').value) {
        populateYearSelectors();
        populateMonthSelectors();
        document.getElementById('suggestedYear').value = year;
    }
    
    try {
        let url = `/api/festivals/${year}`;
        if (month) url += `/${month}`;
        else url += '/0'; // Special case for all months
        
        const response = await fetch(url);
        const festivals = await response.json();
        
        const suggestedList = document.getElementById('suggestedHolidaysList');
        
        if (festivals.length === 0) {
            suggestedList.innerHTML = `
                <div class="empty-state">
                    <p>No festivals found for this period.</p>
                </div>
            `;
            showModal('suggestedHolidaysModal');
            return;
        }
        
        suggestedList.innerHTML = festivals.map(festival => `
            <div class="suggested-holiday">
                <input type="checkbox" id="festival_${festival.date}" value="${festival.date}" 
                       data-name="${festival.festival.name}" 
                       data-type="${festival.festival.type || 'festival'}"
                       data-description="${festival.festival.significance}">
                <label for="festival_${festival.date}">
                    <strong>${festival.festival.name}</strong><br>
                    <small>${new Date(festival.date).toLocaleDateString()} - ${festival.festival.significance}</small>
                </label>
            </div>
        `).join('');
        
        showModal('suggestedHolidaysModal');
        
    } catch (error) {
        showToast('Failed to load suggested holidays: ' + error.message, 'error');
    }
}

async function addSelectedHolidays() {
    const checkedBoxes = document.querySelectorAll('#suggestedHolidaysList input[type="checkbox"]:checked');
    
    if (checkedBoxes.length === 0) {
        showToast('Please select at least one holiday to add.', 'warning');
        return;
    }
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const checkbox of checkedBoxes) {
        try {
            const holidayData = {
                date: checkbox.value,
                name: checkbox.dataset.name,
                type: checkbox.dataset.type,
                description: checkbox.dataset.description
            };
            
            const response = await fetch('/api/holidays', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(holidayData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                successCount++;
            } else {
                errorCount++;
            }
        } catch (error) {
            errorCount++;
        }
    }
    
    closeModal('suggestedHolidaysModal');
    loadHolidays();
    
    if (successCount > 0) {
        showToast(`${successCount} holiday(s) added successfully!`);
    }
    if (errorCount > 0) {
        showToast(`Failed to add ${errorCount} holiday(s).`, 'warning');
    }
}

function saveGeneralSettings() {
    // This would typically save to a backend API
    showToast('Settings saved successfully!');
}

async function exportData() {
    try {
        // This would typically call a backend API to export data
        showToast('Data export feature will be implemented in the backend.', 'info');
    } catch (error) {
        showToast('Failed to export data: ' + error.message, 'error');
    }
}

function importData() {
    const file = document.getElementById('importFile').files[0];
    if (!file) return;
    
    // This would typically upload and process the file
    showToast('Data import feature will be implemented in the backend.', 'info');
}

function confirmClearData() {
    if (confirm('This will permanently delete ALL data including workers, attendance, and payroll records. Are you sure?')) {
        if (confirm('This action cannot be undone. Type "DELETE" to confirm.')) {
            // This would typically call a backend API to clear data
            showToast('Data clearing feature will be implemented in the backend.', 'info');
        }
    }
}
</script>
{% endblock %}